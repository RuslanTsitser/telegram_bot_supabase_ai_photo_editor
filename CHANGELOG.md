# CHANGELOG

## [2025-10-18] - Реализация генерации изображений из текста и улучшение пользовательского опыта

**Добавлено:**

- `generateImageWithPiapi.ts`: функция `generateImageFromText()` для генерации изображений из текстовых описаний через Piapi API (100 строк)
- `index.ts`: обработчик текстовых сообщений для генерации изображений из описания (66 строк: +66/-1)
- `locales/en.ts`: локализованные сообщения для генерации из текста на английском языке (14 строк: +14/-1)
- `locales/ru.ts`: локализованные сообщения для генерации из текста на русском языке (14 строк: +14/-1)
- `onboarding.ts`: дополнительное медиа в процессе онбординга для улучшения вовлеченности (5 строк)

**Изменено:**

- `users.ts`: рефакторинг функции `upsertUser()` с улучшенной обработкой существующих пользователей и созданием премиум-статуса (79 строк: +68/-11)

**Технические детали:**

- Полная поддержка генерации изображений из текстовых описаний
- Валидация пользователей и обработка ошибок при генерации
- Локализованные сообщения для нового функционала
- Улучшенная логика создания и обновления пользователей в БД
- Автоматическое создание премиум-статуса для новых пользователей

## [2025-10-18] - Улучшение онбординга и интернационализация

**Добавлено:**

- `i18n.ts`: система интернационализации с поддержкой английского и русского языков (94 строки)
- `locales/index.ts`: экспорт локализованных строк для многоязычной поддержки (22 строки)
- `locales/en.ts`: английские переводы для всех сообщений бота (103 строки)
- `locales/ru.ts`: русские переводы для всех сообщений бота (104 строки)
- `users.ts`: функция `getUserLanguage()` для получения языка пользователя (19 строк)
- Миграция `011_rename_language_code_to_language.sql`: переименование колонки language_code в language (68 строк)

**Изменено:**

- `onboarding.ts`: улучшение сообщений онбординга с персонализацией и проверкой премиум-статуса (82 строки: +80/-81)
- `index.ts`: интеграция системы интернационализации в основные обработчики сообщений (71 строка: +71/-57)
- `db_types.ts`: добавление поля language в интерфейс User (1 строка)
- `docs/src.md`: обновление документации структуры проекта (8 строк: +8/-8)

**Удалено:**

- `generateImageWithGemini.ts`: удаление файла API для Gemini после перехода на Piapi (71 строка)

**Технические детали:**

- Полная поддержка многоязычности с автоматическим определением языка пользователя
- Персонализированные сообщения онбординга с учетом премиум-статуса
- Миграция базы данных для поддержки языковых предпочтений
- Улучшенный пользовательский опыт для международной аудитории

## [2025-10-18] - Поддержка языков и миграция базы данных

**Добавлено:**

- Миграция `009_add_language_to_users.sql`: добавление колонки language_code в таблицу users (12 строк)
- Миграция `010_update_upsert_user_with_language.sql`: обновление функции upsert_user для поддержки языка (54 строки)

**Изменено:**

- `README.md`: замена Google Gemini API на Piapi API в инструкциях по настройке (15 строк: +3/-12)

**Технические детали:**

- Добавление поддержки языковых предпочтений пользователей
- Обновление функций базы данных для работы с языковыми настройками
- Упрощение настройки переменных окружения

## [2025-10-05] - Рефакторинг API генерации изображений и улучшение документации

**Добавлено:**

- `generateImageWithPiapi.ts`: новый API для генерации изображений через Piapi (251 строка)
- `README.md`: демо-секция с прямой ссылкой на Telegram бота для быстрого доступа пользователей (4 строки)

**Изменено:**

- `index.ts`: замена Gemini API на Piapi API в основной логике обработки изображений (31 строка: +15/-16)
- `processImageGroup.ts`: обновление функций обработки групп изображений для использования Piapi API (32 строки: +16/-16)
- `.env.example`: добавление переменной окружения для Piapi API (1 строка)

**Технические детали:**

- Полный переход с Gemini API на Piapi API для генерации изображений
- Обновление всех ссылок и функций для работы с новым API
- Сохранение обратной совместимости с существующей логикой обработки
- Улучшение пользовательского опыта через прямую ссылку на бота

## [2025-10-05] - Обеспечение безопасности и подготовка к публичному доступу

**Безопасность:**

- Очистка истории git от скомпрометированных ключей и токенов
- Удаление реальных BOT_TOKEN из URL-ов в документации
- Замена реальных ключей на заглушки в публичных файлах
- Создание резервной копии репозитория перед очисткой

**Добавлено:**

- `LICENSE`: MIT License для открытого доступа к репозиторию
- Обновленная документация с инструкциями по настройке
- Руководство по вкладу в проект
- Информация о лицензии в README

**Изменено:**

- `README.md`: добавление раздела "Возможности", "Требования", "Настройка"
- `README.md`: подробные инструкции по клонированию и настройке
- `README.md`: добавление информации о лицензии и поддержке
- `gcp-image-uploader/README.md`: замена реальных токенов на заглушки

**Технические детали:**

- Выполнена очистка git истории с помощью `git filter-branch`
- Удалены все упоминания реальных ключей из коммитов
- Очищен git кеш и выполнена garbage collection
- Репозиторий готов к публичному доступу

## [2025-09-21] - Добавление онбординга и улучшение инфраструктуры

**Добавлено:**

- `onboarding.ts`: функция `onboarding()` с руководством пользователя по использованию бота (59 строк)
- `run.sh`: скрипт для запуска GCP image uploader с загрузкой переменных окружения (14 строк)
- `deploy.sh`: скрипт развертывания в папке scripts (9 строк)
- `setup_webhooks.sh`: автоматизация настройки webhook для Telegram бота (10 строк)
- `.env.example`: токен провайдера Yookassa для тестирования платежей (1 строка)
- `CHANGELOG.md`: документация изменений проекта (114 строк)

**Изменено:**

- `index.ts`: интеграция функции онбординга в обработчик команды `/help` (11 строк: +8/-3)
- `README.md`: упрощение инструкций по локальной настройке и развертыванию (18 строк: +9/-16)

## [2025-09-18] - Рефакторинг функций обработки изображений и улучшение UX

**Добавлено:**

- `index.ts`: функциональность отправки фотографий через URL для обратной связи (1 строка)
- `processImageGroup.ts`: поддержка отправки изображений пользователю (1 строка)

**Изменено:**

- `processImageGroup.ts`: рефакторинг функции `processImageGroup()` для использования `telegramUserId` при отправке сообщений (39 строк: +21/-18)
- `index.ts`: упрощение логики построения сообщений подписки, удаление избыточного кода (23 строки: +4/-19)
- `index.ts`: добавление поддержки тестовой подписки в обработчике callback-запросов (23 строки: +17/-6)
- `subscriptionHandlers.ts`: обновление обработчика подписок для различения тестовых и обычных планов (5 строк: +4/-1)

## [2025-09-13] - Улучшение пользовательского опыта и консистентности

**Добавлено:**

- `processImageGroup.ts`: уведомления пользователя на различных этапах обработки изображений (23 строки)

**Изменено:**

- `index.ts`: обновление подписей для использования консистентной русской фразы для мультяшных изображений (2 строки: +1/-1)
- `processImageGroup.ts`: использование `telegramUserId` для отправки сообщений (3 строки: +2/-1)
- `processImageGroup.ts`: обновление подписей для мультяшных изображений (3 строки: +2/-1)
- `imageGroups.ts`: консистентная русская фраза для мультяшных изображений (2 строки: +1/-1)

**Удалено:**

- `deno.lock`: удаление файла блокировки Deno для очистки зависимостей (111 строк)

## [2025-09-11] - Реализация групповой обработки изображений

**Добавлено:**

- `index.ts`: логика создания и управления группами изображений (78 строк)
- `processImageGroup.ts`: новая функция обработки групп изображений (144 строки)
- `imageGroups.ts`: функции управления группами изображений в БД (219 строк)
- `generateImageWithGemini.ts`: поддержка множественных изображений в API (15 строк: +11/-4)
- Миграция `007_create_image_groups_tables.sql`: таблицы `image_groups` и `group_images` с индексами и триггерами (35 строк)
- Миграция `008_add_rls_policies_image_groups.sql`: политики RLS для таблиц групп изображений (13 строк)

**Изменено:**

- `main.go`: расширение структуры `Request` полем `OtherImages`, обновление `UploadFileToGoogleAI()` для обработки списка `UserImageData` (52 строки: +41/-11)
- `README.md`: обновление документации для поддержки множественных изображений (7 строк: +4/-3)

## [2025-09-09] - Улучшение обработки ошибок

**Изменено:**

- `main.go`: рефакторинг сообщений об ошибках, удаление избыточного текста в AI-ответах (5 строк: +2/-3)

## [2025-09-07] - Реализация системы подписок и лимитов генерации

**Добавлено:**

- `index.ts`: проверка лимитов генерации пользователя (26 строк: +25/-1)
- `index.ts`: обработчик команды `/limits` для отображения статуса подписки (30 строк: +29/-1)
- `index.ts`: обработка pre-checkout запросов с валидацией пользователя и плана подписки (31 строка: +28/-3)
- `plans.ts`: функции получения планов подписки (14 строк)
- `subscriptionHandlers.ts`: обработчики подписок и создания инвойсов (54 строки)
- `declension.ts`: функции склонения для форматирования планов (51 строка)
- `premium.ts`: функции управления премиум-статусом и лимитами генерации (90 строк)
- `payment_types.ts`: TypeScript интерфейсы для типов платежей (13 строк)
- `payments.ts`: функции обработки платежей (106 строк)
- `users.ts`: функции создания и обновления пользователей (19 строк)
- `db_types.ts`: интерфейсы `User`, `PremiumStatus`, `SubscriptionPlan`, `Payment` (44 строки)
- Миграция `004_add_generation_limit_function.sql`: функции `add_generation_limit()` и `update_premium_subscription()` (53 строки)
- Миграция `005_add_decrement_function.sql`: функция `decrement_generation_limit()` (16 строк)
- Миграция `006_fix_upsert_user_function.sql`: исправление функции `upsert_user()` (51 строка)

**Изменено:**

- `index.ts`: обновление обработчика текстовых сообщений для запроса изображения и описания (6 строк: +4/-2)
- `index.ts`: рефакторинг получения планов подписки через отдельную функцию (15 строк: +6/-9)
- `index.ts`: упрощение форматирования сообщений подписки, удаление склонения (17 строк: +6/-11)
- `index.ts`: добавление обработки подписок и команд (58 строк: +55/-3)
- `users.ts`: улучшение обработки ошибок в функции `upsertUser()` (22 строки: +11/-11)
- `README.md`: детальное описание процесса проверки премиум-статуса (4 строки: +2/-2)

## [2025-09-06] - Создание базовой инфраструктуры проекта

**Добавлено:**

- `main.go`: основной файл GCP image uploader с поддержкой Google AI (218 строк)
- `index.ts`: основная функция генератора изображений для Telegram бота (139 строк)
- `generateImageWithGemini.ts`: API для генерации изображений через Gemini (64 строки)
- `saveImageToStorage.ts`: функции сохранения изображений в Supabase Storage (50 строк)
- `saveImageFromUrlToStorage.ts`: сохранение изображений по URL (58 строк)
- `deleteImageFromStorage.ts`: удаление изображений из хранилища (19 строк)
- `getImageUrlFromTelegram.ts`: получение URL изображений из Telegram (17 строк)
- `storage.ts`: утилиты для работы с хранилищем (8 строк)
- `Dockerfile`: контейнеризация GCP uploader (34 строки)
- `deploy.sh`: скрипт развертывания (18 строк)
- `go.mod` и `go.sum`: зависимости Go (152 строки)
- `deno.json`: конфигурация Deno (3 строки)
- `tsconfig.json`: конфигурация TypeScript (111 строк)
- `config.toml`: конфигурация Supabase (289 строк)
- Миграция `001_create_tables.sql`: таблицы `users`, `premium_statuses`, `subscription_plans`, `payments` (78 строк)
- Миграция `002_insert_subscription_plans.sql`: начальные планы подписки (5 строк)
- Миграция `003_add_rls_policies.sql`: политики RLS для всех таблиц (125 строк)

**Изменено:**

- `README.md`: обновление с описанием бизнес-требований и таблиц БД (64 строки: +42/-14)

**Статистика коммитов:**

- Всего коммитов: 38
- Общее количество изменений: 2,500+ строк добавлено, 300+ строк удалено
- Основные файлы: `index.ts` (432 строки), `generateImageWithPiapi.ts` (352 строки), `processImageGroup.ts` (174 строки), `onboarding.ts` (87 строк), `i18n.ts` (94 строки)
- Новые компоненты: генерация изображений из текста, система интернационализации, поддержка многоязычности, улучшенный онбординг
- Последние изменения: добавлена функция `generateImageFromText()` в `generateImageWithPiapi.ts` (100 строк), рефакторинг `upsertUser()` в `users.ts` (79 строк)
