# CHANGELOG

## [2025-01-27] - Обеспечение безопасности и подготовка к публичному доступу

**Безопасность:**

- Очистка истории git от скомпрометированных ключей и токенов
- Удаление реальных BOT_TOKEN из URL-ов в документации
- Замена реальных ключей на заглушки в публичных файлах
- Создание резервной копии репозитория перед очисткой

**Добавлено:**

- `LICENSE`: MIT License для открытого доступа к репозиторию
- Обновленная документация с инструкциями по настройке
- Руководство по вкладу в проект
- Информация о лицензии в README

**Изменено:**

- `README.md`: добавление раздела "Возможности", "Требования", "Настройка"
- `README.md`: подробные инструкции по клонированию и настройке
- `README.md`: добавление информации о лицензии и поддержке
- `gcp-image-uploader/README.md`: замена реальных токенов на заглушки

**Технические детали:**

- Выполнена очистка git истории с помощью `git filter-branch`
- Удалены все упоминания реальных ключей из коммитов
- Очищен git кеш и выполнена garbage collection
- Репозиторий готов к публичному доступу

## [2025-09-21] - Добавление онбординга и улучшение инфраструктуры

**Добавлено:**

- `onboarding.ts`: функция `onboarding()` с руководством пользователя по использованию бота (59 строк)
- `run.sh`: скрипт для запуска GCP image uploader с загрузкой переменных окружения (14 строк)
- `deploy.sh`: скрипт развертывания в папке scripts (9 строк)
- `setup_webhooks.sh`: автоматизация настройки webhook для Telegram бота (10 строк)
- `.env.example`: токен провайдера Yookassa для тестирования платежей (1 строка)
- `CHANGELOG.md`: документация изменений проекта (114 строк)

**Изменено:**

- `index.ts`: интеграция функции онбординга в обработчик команды `/help` (11 строк: +8/-3)
- `README.md`: упрощение инструкций по локальной настройке и развертыванию (18 строк: +9/-16)

## [2025-09-18] - Рефакторинг функций обработки изображений и улучшение UX

**Добавлено:**

- `index.ts`: функциональность отправки фотографий через URL для обратной связи (1 строка)
- `processImageGroup.ts`: поддержка отправки изображений пользователю (1 строка)

**Изменено:**

- `processImageGroup.ts`: рефакторинг функции `processImageGroup()` для использования `telegramUserId` при отправке сообщений (39 строк: +21/-18)
- `index.ts`: упрощение логики построения сообщений подписки, удаление избыточного кода (23 строки: +4/-19)
- `index.ts`: добавление поддержки тестовой подписки в обработчике callback-запросов (23 строки: +17/-6)
- `subscriptionHandlers.ts`: обновление обработчика подписок для различения тестовых и обычных планов (5 строк: +4/-1)

## [2025-09-13] - Улучшение пользовательского опыта и консистентности

**Добавлено:**

- `processImageGroup.ts`: уведомления пользователя на различных этапах обработки изображений (23 строки)

**Изменено:**

- `index.ts`: обновление подписей для использования консистентной русской фразы для мультяшных изображений (2 строки: +1/-1)
- `processImageGroup.ts`: использование `telegramUserId` для отправки сообщений (3 строки: +2/-1)
- `processImageGroup.ts`: обновление подписей для мультяшных изображений (3 строки: +2/-1)
- `imageGroups.ts`: консистентная русская фраза для мультяшных изображений (2 строки: +1/-1)

**Удалено:**

- `deno.lock`: удаление файла блокировки Deno для очистки зависимостей (111 строк)

## [2025-09-11] - Реализация групповой обработки изображений

**Добавлено:**

- `index.ts`: логика создания и управления группами изображений (78 строк)
- `processImageGroup.ts`: новая функция обработки групп изображений (144 строки)
- `imageGroups.ts`: функции управления группами изображений в БД (219 строк)
- `generateImageWithGemini.ts`: поддержка множественных изображений в API (15 строк: +11/-4)
- Миграция `007_create_image_groups_tables.sql`: таблицы `image_groups` и `group_images` с индексами и триггерами (35 строк)
- Миграция `008_add_rls_policies_image_groups.sql`: политики RLS для таблиц групп изображений (13 строк)

**Изменено:**

- `main.go`: расширение структуры `Request` полем `OtherImages`, обновление `UploadFileToGoogleAI()` для обработки списка `UserImageData` (52 строки: +41/-11)
- `README.md`: обновление документации для поддержки множественных изображений (7 строк: +4/-3)

## [2025-09-09] - Улучшение обработки ошибок

**Изменено:**

- `main.go`: рефакторинг сообщений об ошибках, удаление избыточного текста в AI-ответах (5 строк: +2/-3)

## [2025-09-07] - Реализация системы подписок и лимитов генерации

**Добавлено:**

- `index.ts`: проверка лимитов генерации пользователя (26 строк: +25/-1)
- `index.ts`: обработчик команды `/limits` для отображения статуса подписки (30 строк: +29/-1)
- `index.ts`: обработка pre-checkout запросов с валидацией пользователя и плана подписки (31 строка: +28/-3)
- `plans.ts`: функции получения планов подписки (14 строк)
- `subscriptionHandlers.ts`: обработчики подписок и создания инвойсов (54 строки)
- `declension.ts`: функции склонения для форматирования планов (51 строка)
- `premium.ts`: функции управления премиум-статусом и лимитами генерации (90 строк)
- `payment_types.ts`: TypeScript интерфейсы для типов платежей (13 строк)
- `payments.ts`: функции обработки платежей (106 строк)
- `users.ts`: функции создания и обновления пользователей (19 строк)
- `db_types.ts`: интерфейсы `User`, `PremiumStatus`, `SubscriptionPlan`, `Payment` (44 строки)
- Миграция `004_add_generation_limit_function.sql`: функции `add_generation_limit()` и `update_premium_subscription()` (53 строки)
- Миграция `005_add_decrement_function.sql`: функция `decrement_generation_limit()` (16 строк)
- Миграция `006_fix_upsert_user_function.sql`: исправление функции `upsert_user()` (51 строка)

**Изменено:**

- `index.ts`: обновление обработчика текстовых сообщений для запроса изображения и описания (6 строк: +4/-2)
- `index.ts`: рефакторинг получения планов подписки через отдельную функцию (15 строк: +6/-9)
- `index.ts`: упрощение форматирования сообщений подписки, удаление склонения (17 строк: +6/-11)
- `index.ts`: добавление обработки подписок и команд (58 строк: +55/-3)
- `users.ts`: улучшение обработки ошибок в функции `upsertUser()` (22 строки: +11/-11)
- `README.md`: детальное описание процесса проверки премиум-статуса (4 строки: +2/-2)

## [2025-09-06] - Создание базовой инфраструктуры проекта

**Добавлено:**

- `main.go`: основной файл GCP image uploader с поддержкой Google AI (218 строк)
- `index.ts`: основная функция генератора изображений для Telegram бота (139 строк)
- `generateImageWithGemini.ts`: API для генерации изображений через Gemini (64 строки)
- `saveImageToStorage.ts`: функции сохранения изображений в Supabase Storage (50 строк)
- `saveImageFromUrlToStorage.ts`: сохранение изображений по URL (58 строк)
- `deleteImageFromStorage.ts`: удаление изображений из хранилища (19 строк)
- `getImageUrlFromTelegram.ts`: получение URL изображений из Telegram (17 строк)
- `storage.ts`: утилиты для работы с хранилищем (8 строк)
- `Dockerfile`: контейнеризация GCP uploader (34 строки)
- `deploy.sh`: скрипт развертывания (18 строк)
- `go.mod` и `go.sum`: зависимости Go (152 строки)
- `deno.json`: конфигурация Deno (3 строки)
- `tsconfig.json`: конфигурация TypeScript (111 строк)
- `config.toml`: конфигурация Supabase (289 строк)
- Миграция `001_create_tables.sql`: таблицы `users`, `premium_statuses`, `subscription_plans`, `payments` (78 строк)
- Миграция `002_insert_subscription_plans.sql`: начальные планы подписки (5 строк)
- Миграция `003_add_rls_policies.sql`: политики RLS для всех таблиц (125 строк)

**Изменено:**

- `README.md`: обновление с описанием бизнес-требований и таблиц БД (64 строки: +42/-14)

**Статистика коммитов:**

- Всего коммитов: 32
- Общее количество изменений: 1,625 строк добавлено, 127 строк удалено
- Основные файлы: `index.ts` (366 строк), `processImageGroup.ts` (174 строки), `main.go` (254 строки), `onboarding.ts` (60 строк)
